import dataclasses
import threading
import types
from _typeshed import Incomplete
from collections.abc import Iterator
from jax._src import traceback_util as traceback_util
from jax._src.lib import xla_client as xla_client
from typing import NamedTuple

Traceback: Incomplete

class Frame(NamedTuple):
    file_name: str
    function_name: str
    start_line: int
    start_column: int
    end_line: int
    end_column: int

def register_exclusion(path: str): ...

class Scope(NamedTuple):
    name: str
    def wrap(self, stack: tuple[str, ...]) -> tuple[str, ...]: ...

class Transform(NamedTuple):
    name: str
    def wrap(self, stack: tuple[str, ...]) -> tuple[str, ...]: ...

@dataclasses.dataclass(frozen=True)
class NameStack:
    stack: tuple[Scope | Transform, ...] = ...
    def extend(self, name: tuple[str, ...] | str) -> NameStack: ...
    def wrap_name(self, name: str) -> str: ...
    def transform(self, transform_name: str) -> NameStack: ...
    def __getitem__(self, idx: slice) -> NameStack: ...
    def __len__(self) -> int: ...
    def __add__(self, other: NameStack) -> NameStack: ...
    def __radd__(self, other: NameStack) -> NameStack: ...
    def __init__(self, stack) -> None: ...

def new_name_stack(name: str = '') -> NameStack: ...

class SourceInfo(NamedTuple):
    traceback: Traceback | None
    name_stack: NameStack
    def replace(self, *, traceback: Traceback | None = None, name_stack: NameStack | None = None) -> SourceInfo: ...

def new_source_info() -> SourceInfo: ...
def is_user_filename(filename: str) -> bool:
    """Heuristic that guesses the identity of the user's code in a stack trace."""
def raw_frame_to_frame(code: types.CodeType, lasti: int) -> Frame: ...
def user_frames(source_info: SourceInfo) -> Iterator[Frame]:
    """Iterator over the user's frames, filtering jax-internal frames."""
def user_frame(source_info: SourceInfo) -> Frame | None: ...
def summarize(source_info: SourceInfo, num_frames: int = 1) -> str: ...

class _SourceInfoContext(threading.local):
    context: SourceInfo
    def __init__(self) -> None: ...

def current() -> SourceInfo: ...

class JaxStackTraceBeforeTransformation(Exception): ...

def has_user_context(e): ...
def user_context(c: Traceback | None, *, name_stack: NameStack | None = None): ...
def current_name_stack() -> NameStack: ...
def extend_name_stack(name: str) -> Iterator[NameStack]: ...
def set_name_stack(name_stack: NameStack) -> Iterator[None]: ...
def reset_name_stack() -> Iterator[None]: ...
def transform_name_stack(name: str) -> Iterator[NameStack]: ...
