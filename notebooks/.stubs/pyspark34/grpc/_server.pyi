import enum
import grpc
import threading
from _typeshed import Incomplete
from concurrent import futures
from grpc import _interceptor
from grpc._cython import cygrpc as cygrpc
from grpc._typing import ArityAgnosticMethodHandler as ArityAgnosticMethodHandler, ChannelArgumentType as ChannelArgumentType, DeserializingFunction as DeserializingFunction, MetadataType as MetadataType, NullaryCallbackType as NullaryCallbackType, ResponseType as ResponseType, SerializingFunction as SerializingFunction, ServerCallbackTag as ServerCallbackTag, ServerTagCallbackType as ServerTagCallbackType
from typing import Any, Iterable, List, Mapping, NamedTuple, Sequence, Set

class _HandlerCallDetails(NamedTuple('_HandlerCallDetails', [('method', Incomplete), ('invocation_metadata', Incomplete)]), grpc.HandlerCallDetails): ...

class _RPCState:
    condition: threading.Condition
    due = Set[str]
    request: Any
    client: str
    initial_metadata_allowed: bool
    compression_algorithm: grpc.Compression | None
    disable_next_compression: bool
    trailing_metadata: MetadataType | None
    code: grpc.StatusCode | None
    details: bytes | None
    statused: bool
    rpc_errors: List[Exception]
    callbacks: List[NullaryCallbackType] | None
    aborted: bool
    def __init__(self) -> None: ...

class _Context(grpc.ServicerContext):
    request_deserializer: DeserializingFunction | None
    def __init__(self, rpc_event: cygrpc.BaseEvent, state: _RPCState, request_deserializer: DeserializingFunction | None) -> None: ...
    def is_active(self) -> bool: ...
    def time_remaining(self) -> float: ...
    def cancel(self) -> None: ...
    def add_callback(self, callback: NullaryCallbackType) -> bool: ...
    def disable_next_message_compression(self) -> None: ...
    def invocation_metadata(self) -> MetadataType | None: ...
    def peer(self) -> str: ...
    def peer_identities(self) -> Sequence[bytes] | None: ...
    def peer_identity_key(self) -> str | None: ...
    def auth_context(self) -> Mapping[str, Sequence[bytes]]: ...
    def set_compression(self, compression: grpc.Compression) -> None: ...
    def send_initial_metadata(self, initial_metadata: MetadataType) -> None: ...
    def set_trailing_metadata(self, trailing_metadata: MetadataType) -> None: ...
    def trailing_metadata(self) -> MetadataType | None: ...
    def abort(self, code: grpc.StatusCode, details: str) -> None: ...
    def abort_with_status(self, status: grpc.Status) -> None: ...
    def set_code(self, code: grpc.StatusCode) -> None: ...
    def code(self) -> grpc.StatusCode: ...
    def set_details(self, details: str) -> None: ...
    def details(self) -> bytes: ...

class _RequestIterator:
    def __init__(self, state: _RPCState, call: cygrpc.Call, request_deserializer: DeserializingFunction | None) -> None: ...
    def __iter__(self) -> _RequestIterator: ...
    def __next__(self) -> Any: ...
    def next(self) -> Any: ...

class _ServerStage(enum.Enum):
    STOPPED: str
    STARTED: str
    GRACE: str

class _ServerState:
    lock: threading.RLock
    completion_queue: cygrpc.CompletionQueue
    server: cygrpc.Server
    generic_handlers: List[grpc.GenericRpcHandler]
    interceptor_pipeline: _interceptor._ServicePipeline | None
    thread_pool: futures.ThreadPoolExecutor
    stage: _ServerStage
    termination_event: threading.Event
    shutdown_events: List[threading.Event]
    maximum_concurrent_rpcs: int | None
    active_rpc_count: int
    rpc_states: Set[_RPCState]
    due: Set[str]
    server_deallocated: bool
    def __init__(self, completion_queue: cygrpc.CompletionQueue, server: cygrpc.Server, generic_handlers: Sequence[grpc.GenericRpcHandler], interceptor_pipeline: _interceptor._ServicePipeline | None, thread_pool: futures.ThreadPoolExecutor, maximum_concurrent_rpcs: int | None) -> None: ...

class _Server(grpc.Server):
    def __init__(self, thread_pool: futures.ThreadPoolExecutor, generic_handlers: Sequence[grpc.GenericRpcHandler], interceptors: Sequence[grpc.ServerInterceptor], options: Sequence[ChannelArgumentType], maximum_concurrent_rpcs: int | None, compression: grpc.Compression | None, xds: bool) -> None: ...
    def add_generic_rpc_handlers(self, generic_rpc_handlers: Iterable[grpc.GenericRpcHandler]) -> None: ...
    def add_insecure_port(self, address: str) -> int: ...
    def add_secure_port(self, address: str, server_credentials: grpc.ServerCredentials) -> int: ...
    def start(self) -> None: ...
    def wait_for_termination(self, timeout: float | None = None) -> bool: ...
    def stop(self, grace: float | None) -> threading.Event: ...
    def __del__(self) -> None: ...

def create_server(thread_pool: futures.ThreadPoolExecutor, generic_rpc_handlers: Sequence[grpc.GenericRpcHandler], interceptors: Sequence[grpc.ServerInterceptor], options: Sequence[ChannelArgumentType], maximum_concurrent_rpcs: int | None, compression: grpc.Compression | None, xds: bool) -> _Server: ...
