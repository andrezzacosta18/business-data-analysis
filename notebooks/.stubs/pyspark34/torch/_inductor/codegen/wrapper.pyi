import dataclasses
from .. import codecache as codecache, config as config, ir as ir
from ..codecache import cpp_compile_command as cpp_compile_command, get_code_path as get_code_path
from ..utils import cache_on_self as cache_on_self, has_triton as has_triton, sympy_dot as sympy_dot, sympy_product as sympy_product
from ..virtualized import V as V
from .common import CodeGen as CodeGen, DeferredLine as DeferredLine, IndentedBuffer as IndentedBuffer, Kernel as Kernel, PythonPrinter as PythonPrinter
from _typeshed import Incomplete
from torch._dynamo.utils import dynamo_timed as dynamo_timed
from typing import List

pexpr: Incomplete

def buffer_reuse_key(node: ir.Buffer): ...
def make_buffer_reuse(old, new, del_func, declare, ending, as_strided): ...
def make_buffer_allocation(buffer): ...
def make_cpp_buffer_allocation(buffer): ...

class MemoryPlanningState:
    reuse_pool: Incomplete
    def __init__(self) -> None: ...
    def __contains__(self, key) -> bool: ...
    def pop(self, key) -> FreeIfNotReusedLine: ...
    def push(self, key, item: FreeIfNotReusedLine): ...

@dataclasses.dataclass
class EnterCudaDeviceContextManagerLine:
    device_idx: int
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, device_idx) -> None: ...

class ExitCudaDeviceContextManagerLine: ...

class MemoryPlanningLine:
    def plan(self, state: MemoryPlanningState) -> MemoryPlanningLine:
        """First pass to find reuse"""
    def codegen(self, code: IndentedBuffer):
        """Second pass to output code"""

@dataclasses.dataclass
class AllocateLine(MemoryPlanningLine):
    node: ir.Buffer
    def plan(self, state: MemoryPlanningState): ...
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node) -> None: ...

@dataclasses.dataclass
class CppAllocateLine(AllocateLine):
    def plan(self, state: MemoryPlanningState): ...
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node) -> None: ...

@dataclasses.dataclass
class FreeIfNotReusedLine(MemoryPlanningLine):
    node: ir.Buffer
    is_reused: bool = ...
    def plan(self, state: MemoryPlanningState): ...
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node, is_reused) -> None: ...

@dataclasses.dataclass
class CppFreeIfNotReusedLine(FreeIfNotReusedLine):
    node: ir.Buffer
    is_reused: bool = ...
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node, is_reused) -> None: ...

@dataclasses.dataclass
class ReuseLine(MemoryPlanningLine):
    node: ir.Buffer
    reused_as: ir.Buffer
    def plan(self, state: MemoryPlanningState): ...
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node, reused_as) -> None: ...

@dataclasses.dataclass
class CppReuseLine(ReuseLine):
    node: ir.Buffer
    reused_as: ir.Buffer
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node, reused_as) -> None: ...

@dataclasses.dataclass
class FreeLine(MemoryPlanningLine):
    node: ir.Buffer
    def plan(self, state: MemoryPlanningState): ...
    def codegen(self, code: IndentedBuffer): ...
    def __init__(self, node) -> None: ...

class NullLine(MemoryPlanningLine): ...

class WrapperCodeGen(CodeGen):
    """
    The outer wrapper that calls the kernels.
    """
    header: Incomplete
    prefix: Incomplete
    wrapper_call: Incomplete
    kernels: Incomplete
    lines: Incomplete
    allocated: Incomplete
    freed: Incomplete
    reuses: Incomplete
    add_import_once: Incomplete
    def __init__(self) -> None: ...
    def add_meta_once(self, meta): ...
    def get_output_refs(self): ...
    def write_prefix(self) -> None: ...
    def append_precomputed_sizes_to_prefix(self) -> None: ...
    def write_get_cuda_stream(self, index): ...
    def next_kernel_suffix(self): ...
    def write_allocate_line(self, buffer) -> None: ...
    def get_deferred_line(self, name, layout): ...
    def codegen_allocation(self, buffer) -> None: ...
    def write_del_line(self, name) -> None: ...
    def write_free_if_not_reused_line(self, buffer) -> None: ...
    def codegen_free(self, buffer) -> None: ...
    def can_reuse(self, buffer): ...
    def did_reuse(self, buffer, reused_buffer): ...
    def write_reuse_line(self, input_buffer, output_buffer) -> None: ...
    def codegen_inplace_reuse(self, input_buffer, output_buffer) -> None: ...
    def codegen_cuda_device_guard_enter(self, device_idx) -> None: ...
    def codegen_cuda_device_guard_exit(self) -> None: ...
    def generate_return(self, output_refs) -> None: ...
    def generate_end(self, result) -> None: ...
    def generate_extern_kernel_out(self, output_view, codegen_reference, args, kernel, cpp_kernel) -> None: ...
    def generate(self): ...
    def add_benchmark_harness(self, output) -> None:
        """
        Append a benchmark harness to generated code for debugging
        """
    def define_kernel(self, name: str, kernel: str): ...
    def load_kernel(self, name: str = None, kernel: str = None, arg_types: List = None): ...
    def wrap_kernel_call(self, name, call_args): ...
    def generate_kernel_call(self, name, call_args) -> None: ...
    def call_kernel(self, name: str, kernel: Kernel): ...
    def writeline(self, line) -> None: ...

class CppWrapperCodeGen(WrapperCodeGen):
    """
    The outer wrapper that calls the kernels.
    """
    call_func_id: Incomplete
    def __init__(self) -> None: ...
    def get_output_refs(self): ...
    def write_prefix(self) -> None: ...
    def write_allocate_line(self, buffer) -> None: ...
    def write_del_line(self, name) -> None: ...
    def write_free_if_not_reused_line(self, buffer) -> None: ...
    def write_reuse_line(self, input_buffer, output_buffer) -> None: ...
    def get_deferred_line(self, name, layout): ...
    def get_kernel_path(self, code): ...
    def load_kernel(self, name: str = None, kernel: str = None, arg_types: List = None): ...
    def wrap_kernel_call(self, name, call_args): ...
    def generate_return(self, output_refs) -> None: ...
    def generate_end(self, result) -> None: ...
    def generate_extern_kernel_out(self, output_view, codegen_reference, args, kernel, cpp_kernel) -> None: ...
